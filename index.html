<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Corrida - WhatsApp</title>
    <!-- Inclui o Tailwind CSS para estilização fácil e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem; /* Cantos mais arredondados */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        input, textarea {
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            outline: none;
        }
        input:focus, textarea:focus {
            border-color: #6366f1; /* Cor primária do Tailwind indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        button {
            background-color: #25d366; /* Verde do WhatsApp */
            color: white;
            padding: 0.85rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4);
        }
        button:hover {
            background-color: #1da851;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.5);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(37, 211, 102, 0.3);
        }
        button:disabled {
            background-color: #a7f3d0; /* tom mais claro do verde */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        /* Estilo para a mensagem de carregamento/erro */
        #messageBox {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            display: none; /* Escondido por padrão */
        }
        .message-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        #resultsContainer {
            min-height: 80px; /* Garante espaço para os resultados */
        }
        /* Novo estilo para o mapa */
        #map {
            height: 300px; /* Altura fixa para o mapa */
            width: 100%;
            border-radius: 0.75rem;
            margin-top: 1.5rem; /* Espaço acima do mapa */
            margin-bottom: 1.5rem; /* Espaço abaixo do mapa */
        }
    </style>
    <!-- Carrega a API do Google Maps JavaScript -->
    <!-- Substitua 'YOUR_GOOGLE_MAPS_API_KEY' pela sua chave de API real do Google Maps -->
    <!-- A biblioteca 'places' é para o autocomplete, 'callback=initMap' inicializa o código JavaScript após o carregamento da API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6Jr0i1A2LcTSHDbjS1uwj-8xo3QiZOQ0&libraries=places&callback=initMap"></script>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Solicitar Corrida</h1>

        <!-- Campo para o número do motorista (pode ser ocultado ou predefinido) -->
        <div class="mb-4 hidden"> <!-- Hidden para o MVP, pode ser visível para configuração -->
            <label for="driverPhone" class="block text-gray-700 text-left text-sm font-medium mb-2">Número do Motorista (WhatsApp):</label>
            <input type="tel" id="driverPhone" class="w-full" placeholder="Ex: 5511987654321">
            <p class="text-xs text-gray-500 mt-1 text-left">Inclua o código do país e DDD (ex: 5511...)</p>
        </div>

        <div class="mb-4">
            <label for="pickupLocation" class="block text-gray-700 text-left text-sm font-medium mb-2">Local de Partida:</label>
            <input type="text" id="pickupLocation" class="w-full" placeholder="Ex: Minha casa, Rua Exemplo, 123" required list="pickupSuggestions">
            <datalist id="pickupSuggestions"></datalist>
        </div>

        <div class="mb-6">
            <label for="destinationLocation" class="block text-gray-700 text-left text-sm font-medium mb-2">Local de Destino:</label>
            <input type="text" id="destinationLocation" class="w-full" placeholder="Ex: Shopping, Av. Principal, 456" required list="destinationSuggestions">
            <datalist id="destinationSuggestions"></datalist>
        </div>

        <!-- Nova seção para exibir os resultados do cálculo -->
        <div id="resultsContainer" class="bg-gray-100 p-4 rounded-lg hidden mb-6 text-left">
            <p class="text-gray-700 mb-2"><strong>Distância Estimada:</strong> <span id="estimatedDistance">--</span></p>
            <p class="text-gray-700 mb-2"><strong>Tempo Estimado:</strong> <span id="estimatedTime">--</span></p>
            <p class="text-gray-700"><strong>Preço Estimado:</strong> <span id="estimatedPrice">--</span></p>
        </div>

        <!-- Div para o mapa -->
        <div id="map"></div>

        <button id="requestRideButton" class="w-full">
            Solicitar Corrida via WhatsApp
        </button>

        <!-- Caixa de mensagem para feedback ao usuário -->
        <div id="messageBox" class="mt-4 hidden"></div>
    </div>

    <script>
        // *** IMPORTANTE: Substitua 'YOUR_GOOGLE_MAPS_API_KEY' pela sua chave de API real do Google Maps ***
        const GOOGLE_MAPS_API_KEY = 'AIzaSyC6Jr0i1A2LcTSHDbjS1uwj-8xo3QiZOQ0'; // Chave de API extraída do script async defer no head

        // Número de telefone fixo para o motorista (exemplo: Brasil, DDD 31)
        const DRIVER_PHONE_NUMBER = '5538992318721';

        // Variáveis para armazenar os resultados do cálculo
        let calculatedDistanceKm = null;
        let calculatedDurationMinutes = null;
        let calculatedPrice = null;

        // Armazena a localização atual do usuário para usar no viés das sugestões
        let userCurrentLocation = null; // { lat: number, lng: number } - Nota: Google Maps usa 'lng' em vez de 'lon'

        // Google Maps API Services
        let geocoder;
        let directionsService;
        let autocompleteService;
        let map; // Variável global para o objeto do mapa

        // Função para mostrar mensagens na caixa de feedback
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'mt-4 ' + (type === 'success' ? 'message-success' : 'message-error');
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Esconde a mensagem após 5 segundos
        }

        // Função para formatar o tempo de segundos para horas/minutos
        function formatDuration(seconds) {
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) {
                return `${minutes} min`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return `${hours} h ${remainingMinutes} min`;
            }
        }

        // Função para calcular o preço (exemplo simples)
        function calculatePrice(distanceKm) {
            const baseFare = 5.00; // R$ 5,00
            const pricePerKm = 2.50; // R$ 2,50 por km
            return (baseFare + (distanceKm * pricePerKm)).toFixed(2).replace('.', ','); // Formata para 2 casas decimais e usa vírgula
        }

        // Função para geocodificar um endereço usando Google Geocoding API
        async function getCoordinates(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK') {
                        if (results[0]) {
                            const location = results[0].geometry.location;
                            resolve({ lat: location.lat(), lng: location.lng() }); // Usa 'lng'
                        } else {
                            reject(new Error('Nenhum resultado encontrado para o endereço.'));
                        }
                    } else {
                        reject(new Error('Geocodificação Google falhou devido a: ' + status));
                    }
                });
            });
        }

        // Função para obter dados da rota usando Google Directions API
        async function getRouteData(startCoords, endCoords) {
            return new Promise((resolve, reject) => {
                const request = {
                    origin: new google.maps.LatLng(startCoords.lat, startCoords.lng), // Usa 'lng'
                    destination: new google.maps.LatLng(endCoords.lat, endCoords.lng), // Usa 'lng'
                    travelMode: google.maps.TravelMode.DRIVING,
                };

                directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        if (result.routes && result.routes.length > 0) {
                            const route = result.routes[0].legs[0]; // Pega a primeira perna da primeira rota
                            // Opcional: Desenhar a rota no mapa
                            const directionsDisplay = new google.maps.DirectionsRenderer({
                                map: map,
                                polylineOptions: { strokeColor: '#25d366', strokeWeight: 6, strokeOpacity: 0.8 },
                                markerOptions: {
                                    icon: {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        scale: 0, // Esconde os marcadores padrão da rota
                                    }
                                }
                            });
                            directionsDisplay.setDirections(result); // 'result' vem da chamada directionsService.route

                            // Adicionar marcadores personalizados de origem e destino
                            new google.maps.Marker({
                                position: new google.maps.LatLng(pickupCoords.lat, pickupCoords.lng),
                                map: map,
                                title: 'Origem',
                                label: { text: 'A', color: 'white' },
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 10,
                                    fillColor: '#6366f1', // Cor primária Tailwind indigo-500
                                    fillOpacity: 1,
                                    strokeWeight: 0,
                                },
                            });

                            new google.maps.Marker({
                                position: new google.maps.LatLng(destinationCoords.lat, destinationCoords.lng),
                                map: map,
                                title: 'Destino',
                                label: { text: 'B', color: 'white' },
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 10,
                                    fillColor: '#ef4444', // Cor Tailwind red-500
                                    fillOpacity: 1,
                                    strokeWeight: 0,
                                },
                            });

                            // Ajustar o zoom para a rota calculada
                            const bounds = new google.maps.LatLngBounds();
                            bounds.extend(new google.maps.LatLng(pickupCoords.lat, pickupCoords.lng));
                            bounds.extend(new google.maps.LatLng(destinationCoords.lat, destinationCoords.lng));
                            map.fitBounds(bounds);

                            resolve({
                                distance: route.distance.value / 1000, // em km
                                duration: route.duration.value // em segundos
                            });
                        } else {
                            reject(new Error('Nenhuma rota encontrada para os locais fornecidos pelo Google Directions.'));
                        }
                    } else {
                        reject(new Error('Erro do Google Directions API: ' + status));
                    }
                });
            });
        }

        // Função para buscar sugestões de endereço usando Google Places Autocomplete e popular o datalist
        async function fetchAddressSuggestions(query, datalistElement) {
            datalistElement.innerHTML = ''; // Limpa as sugestões anteriores

            if (query.length < 3) {
                return;
            }

            const request = {
                input: query,
                types: ['address'], // 'address' para endereços completos, 'geocode' para endereços e nomes de locais
            };

            // Adiciona viés de localização se userCurrentLocation estiver disponível
            if (userCurrentLocation && userCurrentLocation.lat && userCurrentLocation.lng) {
                request.location = new google.maps.LatLng(userCurrentLocation.lat, userCurrentLocation.lng);
                request.radius = 50000; // Raio de 50km para viés de resultados (ajustável)
            }

            return new Promise((resolve) => {
                autocompleteService.getPlacePredictions(request, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                        predictions.forEach(prediction => {
                            const option = document.createElement('option');
                            option.value = prediction.description; // Usa a descrição completa como sugestão
                            datalistElement.appendChild(option);
                        });
                    }
                    resolve(); // Resolve mesmo se não houver previsões ou erro, para não travar o debounce
                });
            });
        }

        // Função de debounce para evitar chamadas excessivas à API
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // Callback function called when Google Maps API is loaded
        function initMap() {
            // Inicializa os serviços do Google Maps
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            autocompleteService = new google.maps.places.AutocompleteService();

            // Inicializa o mapa
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -23.55052, lng: -46.633309 }, // Centro inicial (ex: São Paulo)
                zoom: 12, // Nível de zoom inicial
                mapTypeControl: false, // Esconde o controle de tipo de mapa
                streetViewControl: false, // Esconde o controle de Street View
                fullscreenControl: false, // Esconde o controle de tela cheia
                zoomControl: true, // Mostra o controle de zoom
            });

            const requestRideButton = document.getElementById('requestRideButton');
            const pickupLocationInput = document.getElementById('pickupLocation');
            const destinationLocationInput = document.getElementById('destinationLocation');
            const estimatedDistanceSpan = document.getElementById('estimatedDistance');
            const estimatedTimeSpan = document.getElementById('estimatedTime');
            const estimatedPriceSpan = document.getElementById('estimatedPrice');
            const resultsContainer = document.getElementById('resultsContainer');
            const pickupSuggestionsDatalist = document.getElementById('pickupSuggestions');
            const destinationSuggestionsDatalist = document.getElementById('destinationSuggestions');

            // Adiciona event listeners para autocomplete com debounce
            const debouncedPickupSuggestions = debounce((e) => fetchAddressSuggestions(e.target.value, pickupSuggestionsDatalist), 500);
            const debouncedDestinationSuggestions = debounce((e) => fetchAddressSuggestions(e.target.value, destinationSuggestionsDatalist), 500);

            pickupLocationInput.addEventListener('input', debouncedPickupSuggestions);
            destinationLocationInput.addEventListener('input', debouncedDestinationSuggestions);


            // Tenta obter a localização atual do usuário para preencher o campo de partida
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => { // Make this async
                        const { latitude, longitude } = position.coords;
                        userCurrentLocation = { lat: latitude, lng: longitude }; // Armazena a localização (usando lng)
                        pickupLocationInput.placeholder = `Obtendo localização...`;
                        try {
                            // Agora usa o Geocoder do Google para o geocoding reverso
                            const address = await new Promise((resolve, reject) => {
                                geocoder.geocode({ 'location': { lat: latitude, lng: longitude } }, (results, status) => {
                                    if (status === 'OK') {
                                        if (results[0]) {
                                            resolve(results[0].formatted_address);
                                        } else {
                                            resolve(`Lat: ${latitude}, Lon: ${longitude}`); // Fallback if no address found
                                        }
                                    } else {
                                        reject(new Error('Reverse Geocoding Google falhou devido a: ' + status));
                                    }
                                });
                            });
                            pickupLocationInput.value = address;
                            // Centraliza o mapa na localização atual do usuário
                            map.setCenter({ lat: latitude, lng: longitude });
                            map.setZoom(15); // Aumenta o zoom para a localização do usuário
                        } catch (error) {
                            console.error('Erro ao obter endereço reverso (Google):', error);
                            showMessage('Não foi possível obter sua localização atual. Digite o local de partida.', 'error');
                        } finally {
                            pickupLocationInput.placeholder = "Ex: Minha casa, Rua Exemplo, 123";
                        }
                    },
                    (error) => {
                        console.error('Erro de geolocalização:', error.name, error.message, error.code);
                        if (error.code === 1 && error.message.includes('Permissions policy')) {
                            console.warn('Geolocation pode estar desabilitada devido a políticas de permissão do ambiente (ex: iframe). O aplicativo funcionará normalmente em um navegador comum.');
                            showMessage('Acesso à localização desabilitado. Digite o local de partida manualmente.', 'error');
                        } else if (error.code === error.PERMISSION_DENIED) {
                            showMessage('Permissão de localização negada. Digite o local de partida manualmente.', 'error');
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            showMessage('Sua localização não está disponível. Digite o local de partida manualmente.', 'error');
                        } else if (error.code === error.TIMEOUT) {
                            showMessage('Tempo limite excedido ao tentar obter sua localização. Digite o local de partida manualmente.', 'error');
                        } else {
                            showMessage('Erro ao obter sua localização. Digite o local de partida.', 'error');
                        }
                        pickupLocationInput.placeholder = "Ex: Minha casa, Rua Exemplo, 123";
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showMessage('Seu navegador não suporta geolocalização. Digite o local de partida.', 'error');
                pickupLocationInput.placeholder = "Ex: Minha casa, Rua Exemplo, 123";
            }

            requestRideButton.addEventListener('click', async () => {
                const pickup = pickupLocationInput.value.trim();
                const destination = destinationLocationInput.value.trim();

                if (!pickup || !destination) {
                    showMessage('Por favor, preencha o local de partida e destino.', 'error');
                    return;
                }

                requestRideButton.disabled = true;
                requestRideButton.textContent = 'Calculando...';
                resultsContainer.classList.add('hidden'); // Esconde resultados anteriores

                try {
                    // 1. Geocodificar os endereços usando Google Geocoding
                    const pickupCoords = await getCoordinates(pickup);
                    const destinationCoords = await getCoordinates(destination);

                    if (!pickupCoords || !destinationCoords) {
                        showMessage('Não foi possível encontrar as coordenadas para os endereços informados.', 'error');
                        return;
                    }

                    // 2. Obter dados da rota (distância e duração) usando Google Directions
                    // A função getRouteData já desenha a rota e adiciona marcadores agora
                    const routeData = await getRouteData(pickupCoords, destinationCoords);
                    calculatedDistanceKm = routeData.distance;
                    calculatedDurationMinutes = routeData.duration;
                    calculatedPrice = calculatePrice(calculatedDistanceKm);

                    // 3. Atualizar a interface com os resultados
                    estimatedDistanceSpan.textContent = `${calculatedDistanceKm.toFixed(1).replace('.', ',')} km`;
                    estimatedTimeSpan.textContent = formatDuration(calculatedDurationMinutes);
                    estimatedPriceSpan.textContent = `R$ ${calculatedPrice}`;
                    resultsContainer.classList.remove('hidden'); // Mostra a seção de resultados

                    // 4. Construir e abrir a URL do WhatsApp
                    const message = `Olá! Gostaria de solicitar uma corrida.\n\n` +
                                    `Partida: ${pickup}\n` +
                                    `Destino: ${destination}\n\n` +
                                    `*Detalhes da Corrida:*\n` +
                                    `Distância Estimada: ${calculatedDistanceKm.toFixed(1).replace('.', ',')} km\n` +
                                    `Tempo Estimado: ${formatDuration(calculatedDurationMinutes)}\n` +
                                    `Preço Estimado: R$ ${calculatedPrice}\n\n` +
                                    `Por favor, confirme a disponibilidade e o valor final.`;

                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/${DRIVER_PHONE_NUMBER}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    showMessage('Abrindo WhatsApp com os detalhes da corrida!', 'success');

                } catch (error) {
                    console.error('Erro completo na solicitação de corrida:', error);
                    let errorMessage = 'Ocorreu um erro ao calcular a rota.';
                    if (error.message.includes('Google') || error.message.includes('falhou')) {
                        errorMessage += ' Verifique sua chave de API do Google Maps, o faturamento e os endereços.';
                    } else if (error.message.includes('Nenhum resultado encontrado') || error.message.includes('Endereço não encontrado')) {
                        errorMessage += ' Por favor, verifique se os endereços estão corretos.';
                    } else if (error.message.includes('Failed to fetch')) {
                        errorMessage += ' Erro de conexão. Verifique sua internet.';
                    }
                    showMessage(errorMessage, 'error');
                    resultsContainer.classList.add('hidden'); // Esconde resultados em caso de erro
                } finally {
                    requestRideButton.disabled = false;
                    requestRideButton.textContent = 'Solicitar Corrida via WhatsApp';
                }
            });
        }
    </script>
</body>
</html>
